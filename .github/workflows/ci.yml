name: CI

on:
  push:
    branches:
      - main
      - dev
      - 'feature/**'
  pull_request:
    branches:
      - main
      - dev
      - 'feature/**'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality Checks (Prettier & ESLint)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Environment versions (debug)
        run: |
          echo "Node version:"
          node -v
          echo "pnpm version:"
          pnpm -v
          echo "Prettier version:"
          pnpm exec prettier --version || echo "Prettier not found"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Prettier debug information
        run: |
          echo "Resolving Prettier config for components/ui/button.tsx"
          pnpm exec prettier components/ui/button.tsx --find-config-path || true

          echo ""
          echo "Resolved configuration:"
          pnpm exec prettier components/ui/button.tsx --config-precedence file-override --print-config || true

          echo ""
          echo "Prettier debug output:"
          pnpm exec prettier components/ui/button.tsx --check --log-level debug || true

      - name: Prettier check with diff
        run: |
          set +e
          pnpm exec prettier . --check
          STATUS=$?
          echo ""
          echo "Files reported by Prettier:"
          pnpm exec prettier . --list-different || true

          echo ""
          echo "Git diff for each changed file:"
          FILES=$(pnpm exec prettier . --list-different || true)
          for f in $FILES; do
            echo "===== DIFF FOR: $f ====="
            git --no-pager diff --color=always "$f" || true
            echo ""
          done

          exit $STATUS

  test:
    name: Unit Tests (Jest + Coverage)
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run Jest tests with coverage
        run: pnpm run test -- --coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
          retention-days: 3

      - name: Check minimum coverage (optional)
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Line coverage: $LINES%"
            THRESHOLD=70
            FAIL=$(echo "$LINES < $THRESHOLD" | bc)
            if [ "$FAIL" -eq 1 ]; then
              echo "::error::Test coverage ($LINES%) is below threshold ($THRESHOLD%)"
              exit 1
            fi
          else
            echo "::warning::coverage-summary.json not found, skipping coverage gate"
          fi

  build:
    name: Build Next.js App (Production Check)
    runs-on: ubuntu-latest
    needs: test

    env:
      # Dummy values only for build; real runtime values are set in ECS task definition (CD)
      POSTGRES_URL: postgresql://dummy:dummy@localhost:5432/dummy
      NEXTAUTH_SECRET: ci-dummy-secret-not-used-in-production-12345
      NEXTAUTH_URL: http://localhost:3000
      NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
      VERCEL_BLOB_TOKEN: dummy-token
      OPENAI_API_KEY: dummy-key

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm run build

      - name: CI summary
        if: always()
        run: |
          echo "## CI Result" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Branch: \`$GITHUB_REF_NAME\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: \`$(echo $GITHUB_SHA | cut -c1-7)\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Quality job:  ${{ needs.quality.result || 'n/a' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Test job:     ${{ needs.test.result || 'n/a' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Build job:    ${{ job.status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "This CI will trigger the CD pipeline to deploy to AWS ECS only when running on the \`main\` branch and all jobs succeed." >> "$GITHUB_STEP_SUMMARY"
