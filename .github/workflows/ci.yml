name: CI

on:
  push:
    branches:
      - main
      - dev
      - 'feature/**'
  pull_request:
    branches:
      - main
      - dev
      - 'feature/**'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: 'ğŸ” Quality Checks (Prettier & ESLint)'
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ£ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: ğŸŸ¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Prettier format check
        run: pnpm run format:check

      - name: ğŸ” Lint with ESLint
        run: pnpm run lint

      - name: ğŸ” (Opsional) Dependency audit (non-blocking)
        run: |
          pnpm audit --prod || echo "âš ï¸ pnpm audit found issues, please review logs manually"

  test:
    name: 'ğŸ§ª Unit Tests (Jest + Coverage)'
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: â¬‡ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ£ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: ğŸŸ¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install 

      - name: ğŸ§ª Run Jest tests with coverage
        run: pnpm run test -- --coverage

      - name: ğŸ“Š Upload coverage artifact (debug & stakeholder)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
          retention-days: 3

      # Contoh simple coverage gate (bisa kamu matikan kalau belum siap)
      - name: âœ… Check minimum coverage (opsional)
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Line coverage: $LINES%"
            # Ubah threshold sesuai kebutuhanmu, misal 70
            THRESHOLD=70
            FAIL=$(echo "$LINES < $THRESHOLD" | bc)
            if [ "$FAIL" -eq 1 ]; then
              echo "::error::Test coverage ($LINES%) di bawah threshold ($THRESHOLD%)"
              exit 1
            fi
          else
            echo "::warning::coverage-summary.json tidak ditemukan, skip coverage gate"
          fi

  build:
    name: 'ğŸš€ Build Next.js App (Production Check)'
    runs-on: ubuntu-latest
    needs: test

    env:
      # Dummy values hanya untuk kebutuhan build; runtime asli diatur di ECS task definition (CD)
      POSTGRES_URL: postgresql://dummy:dummy@localhost:5432/dummy
      NEXTAUTH_SECRET: ci-dummy-secret-not-used-in-production-12345
      NEXTAUTH_URL: http://localhost:3000
      NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
      VERCEL_BLOB_TOKEN: dummy-token
      OPENAI_API_KEY: dummy-key

    steps:
      - name: â¬‡ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ£ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: ğŸŸ¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install 

      - name: ğŸ§± Build project
        run: pnpm run build

      - name: ğŸ§¾ CI Summary
        if: always()
        run: |
          echo "## CI Result" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Branch: \`$GITHUB_REF_NAME\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: \`$(echo $GITHUB_SHA | cut -c1-7)\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Quality job:  ${{ needs.quality.result || 'n/a' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Test job:     ${{ needs.test.result || 'n/a' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Build job:    ${{ job.status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "CI ini akan men-trigger CD Pipeline untuk deploy ke AWS ECS **hanya jika berjalan di branch \`main\` dan semua job sukses**." >> "$GITHUB_STEP_SUMMARY"
